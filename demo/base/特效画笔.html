<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹æ•ˆç”»ç¬”-fabric.js filter layer</title>
    <link rel="stylesheet" href="../css/main.css">

    <!-- <script src="../js/jquery.min.js"></script> -->
</head>

<body>
    <main id="app">
        <h1>ç‰¹æ•ˆç”»ç¬”</h1>
        <!-- <p>xxxxx</p> -->
        <button @click="canvas.isDrawingMode =  !canvas.isDrawingMode ">å¼€å…³ </button>
        <button @click="add">é¼ æ ‡æ‹–æ‹‰æ·»åŠ  </button>
        <br>
        <canvas id="fabricjsDocCn"></canvas>
    </main>
    <script src="../js/fabric.min.js"></script>
    <script src="../js/Fn_fabric.js"></script>
    <script src="../js/vue.min.js"></script>
    <script>
        let llpp = new Vue({
            el: '#app',
            data: {
                canvas: null
            },
            created() {},
            mounted() {
                let _this = this
                // åˆå§‹åŒ–
                this.canvas = Fn_fabric.initCanvas()
                Fn_fabric.initObject()
                this.canvas.setBackgroundColor({
                    source: '../images/bg.jpg'
                }, () => {
                    this.canvas.renderAll()
                    ///////////////////////////////////////////////////
                    // é¢„å…ˆåŠ å¥½ç‰¹æŠ€ï¼Œåˆ›å»ºæˆåŠŸååœ¨æ­£å¼ addFilterLayer
                    function creatFilterBrush(canvas) {
                        let filter = {
                            // æ¨¡ç³Š 0 -1
                            blur: new fabric.Image.filters.Blur({
                                blur: .3
                            }),
                            //   åƒç´ ç”» 1-1000
                            blocksize: new fabric.Image.filters.Pixelate({
                                blocksize: 10
                            })
                        }
                        let img = new fabric.Image(canvas.toCanvasElement(), {});
                        img.filters.push(filter.blur);
                        img.applyFilters();
                        let brush = new fabric.PatternBrush(canvas);
                        brush.source = img.getElement()
                        brush.width = 30
                        brush._type = 'filterBrush'
                        return brush
                    }
                    let closeBrush = () => {
                        this.canvas.isDrawingMode = false
                    }
                    setTimeout(() => {
                        this.canvas.isDrawingMode = true
                        this.canvas.freeDrawingBrush = creatFilterBrush(_this.canvas)
                        setTimeout(() => {
                            closeBrush()
                        }, 10000);
                    }, 2000);
                    this.canvas.on('mouse:down', function (e) {
                    })
                    this.canvas.on('mouse:up', function (e) {
                        // å¦‚æœæ˜¯æ»¤é•œç”»ç¬”ï¼Œç”Ÿæˆæ»¤é•œæ¶‚å±‚
                        if (_this.canvas.isDrawingMode && _this.canvas.freeDrawingBrush
                            ._type === 'filterBrush') {
                            let brushPath = _this.canvas.item(_this.canvas.size() - 1)
                            addFilterLayer(_this.canvas, brushPath, 'stroke')
                        }
                        // å¦‚æœæ˜¯æ»¤é•œç”»ç¬”ï¼Œæ›´æ–°canvasæˆªå›¾
                        if (!_this.canvas.isDrawingMode && _this.canvas.freeDrawingBrush
                            ._type === 'filterBrush') {
                            _this.canvas.freeDrawingBrush = creatFilterBrush(_this.canvas)
                            console.log('down');

                        }
                    })


                    let t1 = new fabric.Rect({
                        width: 100,
                        height: 100,
                        left: 100
                    });
                    let t2 = new fabric.Rect({
                        width: 100,
                        height: 100,
                        left: 200
                    });
                    let t3 = new fabric.Rect({
                        width: 200,
                        height: 100,
                        left: 500
                    });
                    let t4 = new fabric.Rect({
                        width: 100,
                        height: 100,
                        left: 100,
                        fill: 'yellow'
                    });
                    let t5 = new fabric.Rect({
                        width: 120,
                        height: 320,
                        left: 300,
                        fill: 'blue'
                    });
                    this.canvas.add(t4)
                    this.canvas.add(t5)
                    this.canvas.add(t1)
                    this.canvas.add(t2)
                    this.canvas.add(t3)

                    addFilterLayer(this.canvas, t1)
                    addFilterLayer(this.canvas, t2)
                    addFilterLayer(this.canvas, t3)



                });

                // ç»™å·²å­˜åœ¨çš„ç‰©ä»¶æ·»åŠ ç‰¹æ•ˆ
                function addFilterLayer(canvas, obj, where = 'fill') {
                    /**
                     *  æ€è·¯ï¼š
                     *  01. let el = canvas.toCanvasElement()æ–¹æ³•è·å–ç”»å¸ƒçš„dom
                     *  02. ä½¿ç”¨new fabric.Image(el,{})åŠ è½½dom
                     *  03. é€‚ä½¿ç”¨æ»¤é•œ
                     *  04. Image.getElement()è·å–img dom
                     *  05. æœ€ååŠ è¿›new fabric.Pattern({source: img})
                     * 
                     * @where   'fill'  æ™®é€šç‰©ä»¶å¡«å……
                     *          'stroke'ç”»ç¬”æè¾¹
                     */
                    let index,
                        id,
                        paoffset,
                        pattern,
                        filter,
                        updateObj;

                    index = canvas.getObjects().filter(f => f.id && f.id.includes('filterLayer')).length
                    id = `filterLayer_${index}`
                    // è®¡ç®—èƒŒæ™¯åç§»
                    offset = (obj) => {
                        if (where === 'fill') {
                            return {
                                x: -obj.left,
                                y: -obj.top
                            }
                        } else if (where === 'stroke') {
                            return {
                                x: -obj.left - obj.strokeWidth / 2,
                                y: -obj.top - obj.strokeWidth / 2
                            }
                        }
                    }
                    filter = {
                        // æ¨¡ç³Š 0 -1
                        blur: new fabric.Image.filters.Blur({
                            blur: .3
                        }),
                        //   åƒç´ ç”» 1-1000
                        blocksize: new fabric.Image.filters.Pixelate({
                            blocksize: 10
                        })
                    }
                    pattern = new fabric.Pattern({
                        source: null,
                        repeat: 'no-repeat'
                    })
                    obj.id = id
                    obj[where] = pattern

                    obj.setControlsVisibility({
                        mtr: false,
                    })
                    // æ›´æ–°æ•ˆæœ
                    updateObj = () => {
                        // æ¸…é™¤ç‰¹æ•ˆå›¾å±‚indexä»¥ä¸Šçš„å›¾å±‚
                        let allObj = canvas.getObjects()
                        let needChange = []
                        allObj.map((m, ind) => m._moveTo = ind)
                        allObj.map((m, ind) => {
                            if (ind >= obj._moveTo) {
                                needChange.push(m)
                                canvas.remove(m)
                            }
                        })
                        console.log(222);
                        // ç”»å¸ƒè½¬domåæ”¾å…¥fabric.ImageåŠ ç‰¹æŠ€
                        let img = new fabric.Image(canvas.toCanvasElement(), {});
                        img.filters.push(filter.blur);
                        img.applyFilters();
                        // åŠ å®Œç‰¹æŠ€å¯¼å…¥å›¾æ¡ˆ
                        pattern.source = img.getElement()
                        pattern.offsetX = offset(obj).x
                        pattern.offsetY = offset(obj).y
                        // è¿˜åŸæ¸…é™¤
                        needChange.map(((m, ind) => {
                            canvas.add(m)
                        }))
                        canvas.renderAll()
                        // æ‰€æœ‰objåŠ å…¥çš„è‡ªå®šä¹‰å±æ€§_moveTo,è€ƒè™‘ä¸‹æœ‰æ²¡å¿…è¦åˆ ï¼ŸğŸ¤”ï¸
                        // needChange.map(((m,ind)=>{
                        //     m.moveTo(m._moveTo)
                        //     // delete m._moveTo
                        // }))
                    }
                    updateObj()
                    // æ‰€æœ‰å›¾å±‚æ”¹å˜æ—¶ï¼Œæ›´æ–°æ•ˆæœ
                    canvas.on('object:modified', function (e) {
                        canvas.getObjects().map((m, ind) => {
                            m._moveTo = ind
                        })
                        // åªæ”¹å˜è¢«æ”¹å˜å›¾å±‚ä¹‹ä¸Šçš„
                        if (e.target._moveTo <= obj._moveTo) {
                            console.log(111);
                            updateObj()
                        }
                    })
                    // ç§»åŠ¨æ—¶è®©èƒŒæ™¯patternåå·®ï¼Œè¾¾åˆ°è§†è§‰èƒŒæ™¯å›ºå®šçš„æ•ˆæœ
                    canvas.on('object:moving', function (e) {
                        if (e.target.id === id) {
                            obj[where].offsetX = offset(obj).x
                            obj[where].offsetY = offset(obj).y
                        }
                    })
                    // ç¼©æ”¾æ—¶ä¿æŒscaleXã€scaleYï¼Œæ”¹å˜widthå’Œheight
                    canvas.on('object:scaling', function (e) {
                        if (e.target.id === id) {
                            obj.set({
                                'height': obj.height * obj.scaleY,
                                'width': obj.width * obj.scaleX,
                                'scaleX': 1,
                                'scaleY': 1
                            });
                            obj[where].offsetX = offset(obj).x
                            obj[where].offsetY = offset(obj).y
                        }
                    })
                }



            },
            updated() {},
            methods: {
                add() {}
            },
            computed: {},
            watch: {}
        })
    </script>
</body>
<!-- from: https://github.com/renzhezhilu/fabric.js-doc-cn -->

</html>